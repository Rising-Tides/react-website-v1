{"ast":null,"code":"import _objectWithoutProperties from '@babel/runtime/helpers/objectWithoutProperties';\nimport _defineProperty from '@babel/runtime/helpers/defineProperty';\nimport NodeDetailManager from '@toruslabs/fetch-node-details';\nimport { get, setAPIKey } from '@toruslabs/http-helpers';\nimport { SafeEventEmitter, ObjectMultiplex, createStreamMiddleware, JRPCEngine, createIdRemapMiddleware, BasePostMessageStream, setupMultiplex } from '@toruslabs/openlogin-jrpc';\nimport TorusJs from '@toruslabs/torus.js';\nimport deepmerge from 'lodash.merge';\nimport { ObservableStore, storeAsStream } from '@metamask/obs-store';\nimport { ethErrors, EthereumRpcError } from 'eth-rpc-errors';\nimport dequal from 'fast-deep-equal';\nimport { isDuplexStream } from 'is-stream';\nimport pump from 'pump';\nimport loglevel from 'loglevel';\nimport createHash from 'create-hash';\nimport { EventEmitter } from 'events';\nconst LOGIN_PROVIDER = {\n  GOOGLE: \"google\",\n  FACEBOOK: \"facebook\",\n  TWITCH: \"twitch\",\n  REDDIT: \"reddit\",\n  DISCORD: \"discord\"\n};\nconst WALLET_OPENLOGIN_VERIFIER_MAP = {\n  [LOGIN_PROVIDER.GOOGLE]: \"tkey-google\",\n  [LOGIN_PROVIDER.FACEBOOK]: \"tkey-facebook\",\n  [LOGIN_PROVIDER.TWITCH]: \"tkey-twitch\",\n  [LOGIN_PROVIDER.REDDIT]: \"tkey-reddit\",\n  [LOGIN_PROVIDER.DISCORD]: \"tkey-discord\"\n};\nconst PAYMENT_PROVIDER = {\n  MOONPAY: \"moonpay\",\n  WYRE: \"wyre\",\n  RAMPNETWORK: \"rampnetwork\",\n  XANPOOL: \"xanpool\",\n  MERCURYO: \"mercuryo\",\n  TRANSAK: \"transak\"\n};\nconst TORUS_BUILD_ENV = {\n  PRODUCTION: \"production\",\n  DEVELOPMENT: \"development\",\n  BINANCE: \"binance\",\n  TESTING: \"testing\",\n  LRC: \"lrc\",\n  BETA: \"beta\"\n};\nconst BUTTON_POSITION = {\n  BOTTOM_LEFT: \"bottom-left\",\n  TOP_LEFT: \"top-left\",\n  BOTTOM_RIGHT: \"bottom-right\",\n  TOP_RIGHT: \"top-right\"\n};\nconst paymentProviders$1 = {\n  [PAYMENT_PROVIDER.RAMPNETWORK]: {\n    line1: \"Debit Card/ Apple Pay/ Bank transfer\",\n    line2: \"0.49% - 2.9%\",\n    line3: \"5,000€/purchase, 20,000€/mo\",\n    supportPage: \"https://instant.ramp.network/\",\n    minOrderValue: 50,\n    maxOrderValue: 20000,\n    validCurrencies: [\"GBP\", \"EUR\", \"USD\"],\n    validCryptoCurrencies: [\"ETH\", \"DAI\", \"USDC\", \"BSC_BNB\"],\n    includeFees: true,\n    enforceMax: false\n  },\n  [PAYMENT_PROVIDER.MOONPAY]: {\n    line1: \"Credit / Debit Card / Apple Pay\",\n    line2: \"4.5% or 5 USD\",\n    line3: \"2,000€/day, 10,000€/mo\",\n    supportPage: \"https://help.moonpay.io/en/\",\n    minOrderValue: 24.99,\n    maxOrderValue: 50000,\n    validCurrencies: [\"USD\", \"EUR\", \"GBP\", \"AUD\", \"CAD\", \"SGD\", \"RUB\"],\n    validCryptoCurrencies: [\"ETH\", \"DAI\", \"TUSD\", \"USDC\", \"USDT\", \"BNB_BSC\", \"BUSD_BSC\"],\n    includeFees: true,\n    enforceMax: false\n  },\n  [PAYMENT_PROVIDER.WYRE]: {\n    line1: \"Apple Pay/ Debit/ Credit Card\",\n    line2: \"4.9% + 30¢ or 5 USD\",\n    line3: \"$250/day\",\n    supportPage: \"https://support.sendwyre.com/en/\",\n    minOrderValue: 5,\n    maxOrderValue: 500,\n    validCurrencies: [\"USD\", \"AUD\", \"CAD\", \"GBP\", \"EUR\"],\n    validCryptoCurrencies: [\"ETH\", \"DAI\", \"USDC\", \"USDT\"],\n    includeFees: false,\n    enforceMax: false\n  },\n  [PAYMENT_PROVIDER.XANPOOL]: {\n    line1: \"PayNow/ InstaPay/ FPS/ GoJekPay/ UPI/ PromptPay/ VietelPay/ DuitNow\",\n    line2: \"2.5% buying, 3% selling\",\n    line3: \"$2,500 / day\",\n    supportPage: \"mailto:support@xanpool.com\",\n    minOrderValue: 100,\n    maxOrderValue: 2500,\n    validCurrencies: [\"SGD\", \"HKD\", \"MYR\", \"PHP\", \"INR\", \"VND\", \"THB\", \"IDR\"],\n    validCryptoCurrencies: [\"ETH\", \"USDT\"],\n    includeFees: true,\n    sell: true,\n    enforceMax: false\n  },\n  [PAYMENT_PROVIDER.MERCURYO]: {\n    line1: \"Credit/ Debit Card/ Apple Pay\",\n    line2: \"3.95% or 4 USD\",\n    line3: \"10,000€/day, 25,000€/mo\",\n    supportPage: \"mailto:support@mercuryo.io\",\n    minOrderValue: 30,\n    maxOrderValue: 5000,\n    validCurrencies: [\"USD\", \"EUR\", \"RUB\", \"TRY\", \"GBP\", \"UAH\"],\n    validCryptoCurrencies: [\"ETH\", \"DAI\", \"BAT\", \"USDT\", \"OKB\"],\n    includeFees: true,\n    enforceMax: false\n  },\n  [PAYMENT_PROVIDER.TRANSAK]: {\n    line1: \"Credit/ Debit Card/ <br/>Bank Transfer (sepa/gbp)\",\n    line2: \"0.99% - 5.5% or 5 USD\",\n    line3: \"500€/day\",\n    supportPage: \"https://support.transak.com/hc/en-US\",\n    minOrderValue: 20,\n    maxOrderValue: 500,\n    validCurrencies: [\"USD\", \"EUR\", \"GBP\", \"AUD\", \"CAD\", \"SGD\"],\n    validCryptoCurrencies: [\"ETH\", \"DAI\", \"USDC\", \"USDT\"],\n    includeFees: true,\n    enforceMax: false\n  }\n};\nconst translations = {\n  en: {\n    embed: {\n      continue: \"Continue\",\n      actionRequired: \"Authorization required\",\n      pendingAction: \"Click continue to proceed with your request in a popup\",\n      cookiesRequired: \"Cookies Required\",\n      enableCookies: \"Please enable cookies in your browser preferences to access Torus\",\n      clickHere: \"More Info\"\n    }\n  },\n  de: {\n    embed: {\n      continue: \"Fortsetzen\",\n      actionRequired: \"Autorisierung erforderlich\",\n      pendingAction: \"Klicken Sie in einem Popup auf Weiter, um mit Ihrer Anfrage fortzufahren\",\n      cookiesRequired: \"Cookies benötigt\",\n      enableCookies: \"Bitte aktivieren Sie Cookies in Ihren Browsereinstellungen, um auf Torus zuzugreifen\",\n      clickHere: \"Mehr Info\"\n    }\n  },\n  ja: {\n    embed: {\n      continue: \"継続する\",\n      actionRequired: \"認証が必要です\",\n      pendingAction: \"続行をクリックして、ポップアップでリクエストを続行します\",\n      cookiesRequired: \"必要なクッキー\",\n      enableCookies: \"Torusにアクセスするには、ブラウザの設定でCookieを有効にしてください。\",\n      clickHere: \"詳しくは\"\n    }\n  },\n  ko: {\n    embed: {\n      continue: \"계속하다\",\n      actionRequired: \"승인 필요\",\n      pendingAction: \"팝업에서 요청을 진행하려면 계속을 클릭하십시오.\",\n      cookiesRequired: \"쿠키 필요\",\n      enableCookies: \"브라우저 환경 설정에서 쿠키를 활성화하여 Torus에 액세스하십시오.\",\n      clickHere: \"더 많은 정보\"\n    }\n  },\n  zh: {\n    embed: {\n      continue: \"继续\",\n      actionRequired: \"需要授权\",\n      pendingAction: \"单击继续以在弹出窗口中继续您的请求\",\n      cookiesRequired: \"必填Cookie\",\n      enableCookies: \"请在您的浏览器首选项中启用cookie以访问Torus。\",\n      clickHere: \"更多信息\"\n    }\n  }\n};\nvar configuration = {\n  supportedVerifierList: [LOGIN_PROVIDER.GOOGLE, LOGIN_PROVIDER.REDDIT, LOGIN_PROVIDER.DISCORD],\n  paymentProviders: paymentProviders$1,\n  api: \"https://api.tor.us\",\n  translations,\n  prodTorusUrl: \"\",\n  localStorageKey: \"torus-\".concat(window.location.hostname)\n};\n\nconst runOnLoad = fn => new Promise((resolve, reject) => {\n  if (window.document.body != null) {\n    Promise.resolve(fn()).then(resolve).catch(reject);\n  } else {\n    window.document.addEventListener(\"DOMContentLoaded\", () => {\n      Promise.resolve(fn()).then(resolve).catch(reject);\n    });\n  }\n});\n\nconst htmlToElement = html => {\n  const template = window.document.createElement(\"template\");\n  const trimmedHtml = html.trim(); // Never return a text node of whitespace as the result\n\n  template.innerHTML = trimmedHtml;\n  return template.content.firstChild;\n};\n\nconst handleEvent = function (handle, eventName, handler) {\n  for (var _len = arguments.length, handlerArgs = new Array(_len > 3 ? _len - 3 : 0), _key = 3; _key < _len; _key++) {\n    handlerArgs[_key - 3] = arguments[_key];\n  }\n\n  const handlerWrapper = () => {\n    handler(...handlerArgs);\n    handle.removeEventListener(eventName, handlerWrapper);\n  };\n\n  handle.addEventListener(eventName, handlerWrapper);\n};\n\nconst handleStream = (handle, eventName, handler) => {\n  const handlerWrapper = chunk => {\n    handler(chunk);\n    handle.removeListener(eventName, handlerWrapper);\n  };\n\n  handle.on(eventName, handlerWrapper);\n};\n\nasync function documentReady() {\n  return new Promise(resolve => {\n    if (document.readyState !== \"loading\") {\n      resolve();\n    } else {\n      handleEvent(document, \"DOMContentLoaded\", resolve);\n    }\n  });\n}\n\nvar log = loglevel.getLogger(\"torus-embed\");\nvar messages = {\n  errors: {\n    disconnected: () => \"Torus: Lost connection to Torus.\",\n    permanentlyDisconnected: () => \"Torus: Disconnected from iframe. Page reload required.\",\n    sendSiteMetadata: () => \"Torus: Failed to send site metadata. This is an internal error, please report this bug.\",\n    unsupportedSync: method => \"Torus: The Torus Ethereum provider does not support synchronous methods like \".concat(method, \" without a callback parameter.\"),\n    invalidDuplexStream: () => \"Must provide a Node.js-style duplex stream.\",\n    invalidOptions: (maxEventListeners, shouldSendMetadata) => \"Invalid options. Received: { maxEventListeners: \".concat(maxEventListeners, \", shouldSendMetadata: \").concat(shouldSendMetadata, \" }\"),\n    invalidRequestArgs: () => \"Expected a single, non-array, object argument.\",\n    invalidRequestMethod: () => \"'args.method' must be a non-empty string.\",\n    invalidRequestParams: () => \"'args.params' must be an object or array if provided.\",\n    invalidLoggerObject: () => \"'args.logger' must be an object if provided.\",\n    invalidLoggerMethod: method => \"'args.logger' must include required method '\".concat(method, \"'.\")\n  },\n  info: {\n    connected: chainId => \"Torus: Connected to chain with ID \\\"\".concat(chainId, \"\\\".\")\n  },\n  warnings: {\n    // deprecated methods\n    enableDeprecation: 'Torus: \"\"ethereum.enable()\" is deprecated and may be removed in the future. ' + 'Please use \"ethereum.send(\"eth_requestAccounts\")\" instead. For more information, see: https://eips.ethereum.org/EIPS/eip-1102',\n    sendDeprecation: 'Torus: \"ethereum.send(...)\" is deprecated and may be removed in the future.' + ' Please use \"ethereum.sendAsync(...)\" or \"ethereum.request(...)\" instead.\\nFor more information, see: https://eips.ethereum.org/EIPS/eip-1193',\n    events: {\n      close: 'Torus: The event \"close\" is deprecated and may be removed in the future. Please use \"disconnect\" instead.' + \"\\nFor more information, see: https://eips.ethereum.org/EIPS/eip-1193\",\n      data: 'Torus: The event \"data\" is deprecated and will be removed in the future.' + 'Use \"message\" instead.\\nFor more information, see: https://eips.ethereum.org/EIPS/eip-1193#message',\n      networkChanged: 'Torus: The event \"networkChanged\" is deprecated and may be removed in the future.' + ' Please use \"chainChanged\" instead.\\nFor more information, see: https://eips.ethereum.org/EIPS/eip-1193',\n      notification: 'Torus: The event \"notification\" is deprecated and may be removed in the future. ' + 'Please use \"message\" instead.\\nFor more information, see: https://eips.ethereum.org/EIPS/eip-1193'\n    },\n    publicConfigStore: 'Torus: The property \"publicConfigStore\" is deprecated and WILL be removed in the future.'\n  }\n};\nconst {\n  paymentProviders\n} = configuration;\n\nconst validatePaymentProvider = (provider, params) => {\n  const errors = {};\n\n  if (!provider) {\n    return {\n      errors,\n      isValid: true\n    };\n  }\n\n  if (provider && !paymentProviders[provider]) {\n    errors.provider = \"Invalid Provider\";\n    return {\n      errors,\n      isValid: Object.keys(errors).length === 0\n    };\n  }\n\n  const selectedProvider = paymentProviders[provider];\n  const selectedParams = params || {}; // set default values\n  // if (!selectedParams.selectedCurrency) [selectedParams.selectedCurrency] = selectedProvider.validCurrencies\n  // if (!selectedParams.fiatValue) selectedParams.fiatValue = selectedProvider.minOrderValue\n  // if (!selectedParams.selectedCryptoCurrency) [selectedParams.selectedCryptoCurrency] = selectedProvider.validCryptoCurrencies\n  // validations\n\n  if (selectedParams.fiatValue) {\n    const requestedOrderAmount = +parseFloat(selectedParams.fiatValue.toString()) || 0;\n    if (requestedOrderAmount < selectedProvider.minOrderValue) errors.fiatValue = \"Requested amount is lower than supported\";\n    if (requestedOrderAmount > selectedProvider.maxOrderValue && selectedProvider.enforceMax) errors.fiatValue = \"Requested amount is higher than supported\";\n  }\n\n  if (selectedParams.selectedCurrency && !selectedProvider.validCurrencies.includes(selectedParams.selectedCurrency)) {\n    errors.selectedCurrency = \"Unsupported currency\";\n  }\n\n  if (selectedParams.selectedCryptoCurrency && !selectedProvider.validCryptoCurrencies.includes(selectedParams.selectedCryptoCurrency)) {\n    errors.selectedCryptoCurrency = \"Unsupported cryptoCurrency\";\n  }\n\n  return {\n    errors,\n    isValid: Object.keys(errors).length === 0\n  };\n}; // utility functions\n\n/**\n * json-rpc-engine middleware that logs RPC errors and and validates req.method.\n *\n * @param log - The logging API to use.\n * @returns  json-rpc-engine middleware function\n */\n\n\nfunction createErrorMiddleware() {\n  return (req, res, next) => {\n    // json-rpc-engine will terminate the request when it notices this error\n    if (typeof req.method !== \"string\" || !req.method) {\n      res.error = ethErrors.rpc.invalidRequest({\n        message: \"The request 'method' must be a non-empty string.\",\n        data: req\n      });\n    }\n\n    next(done => {\n      const {\n        error\n      } = res;\n\n      if (!error) {\n        return done();\n      }\n\n      log.error(\"MetaMask - RPC Error: \".concat(error.message), error);\n      return done();\n    });\n  };\n} // resolve response.result or response, reject errors\n\n/**\n * Logs a stream disconnection error. Emits an 'error' if given an\n * EventEmitter that has listeners for the 'error' event.\n *\n * @param log - The logging API to use.\n * @param remoteLabel - The label of the disconnected stream.\n * @param error - The associated error to log.\n * @param emitter - The logging API to use.\n */\n\n\nfunction logStreamDisconnectWarning(remoteLabel, error, emitter) {\n  let warningMsg = \"MetaMask: Lost connection to \\\"\".concat(remoteLabel, \"\\\".\");\n\n  if (error !== null && error !== void 0 && error.stack) {\n    warningMsg += \"\\n\".concat(error.stack);\n  }\n\n  log.warn(warningMsg);\n\n  if (emitter && emitter.listenerCount(\"error\") > 0) {\n    emitter.emit(\"error\", warningMsg);\n  }\n}\n\nconst getPreopenInstanceId = () => Math.random().toString(36).slice(2);\n\nconst getTorusUrl = async (buildEnv, integrity) => {\n  let torusUrl;\n  let logLevel; // Do not change this line\n\n  const version = \"1.21.0\";\n  let versionUsed = integrity.version || version;\n\n  try {\n    if ((buildEnv === \"binance\" || buildEnv === \"production\") && !integrity.version) {\n      let response;\n      if (!configuration.prodTorusUrl) response = await get(\"\".concat(configuration.api, \"/latestversion?name=@toruslabs/torus-embed&version=\").concat(version), {}, {\n        useAPIKey: true\n      });else response = {\n        data: configuration.prodTorusUrl\n      };\n      versionUsed = response.data; // eslint-disable-next-line require-atomic-updates\n\n      configuration.prodTorusUrl = response.data;\n    }\n  } catch (error) {\n    log.error(error, \"unable to fetch latest version\");\n  }\n\n  log.info(\"version used: \", versionUsed);\n\n  switch (buildEnv) {\n    case \"binance\":\n      torusUrl = \"https://binance.tor.us/v\".concat(versionUsed);\n      logLevel = \"info\";\n      break;\n\n    case \"testing\":\n      torusUrl = \"https://testing.tor.us\";\n      logLevel = \"debug\";\n      break;\n\n    case \"lrc\":\n      torusUrl = \"https://lrc.tor.us\";\n      logLevel = \"debug\";\n      break;\n\n    case \"beta\":\n      torusUrl = \"https://beta.tor.us\";\n      logLevel = \"debug\";\n      break;\n\n    case \"development\":\n      torusUrl = \"http://localhost:4050\";\n      logLevel = \"debug\";\n      break;\n\n    default:\n      torusUrl = \"https://app.tor.us/v\".concat(versionUsed);\n      logLevel = \"error\";\n      break;\n  }\n\n  return {\n    torusUrl,\n    logLevel\n  };\n};\n\nconst getUserLanguage = () => {\n  let userLanguage = window.navigator.language || \"en-US\";\n  const userLanguages = userLanguage.split(\"-\");\n  userLanguage = Object.prototype.hasOwnProperty.call(configuration.translations, userLanguages[0]) ? userLanguages[0] : \"en\";\n  return userLanguage;\n};\n\nconst EMITTED_NOTIFICATIONS = [\"eth_subscription\" // per eth-json-rpc-filters/subscriptionManager\n];\n\nconst NOOP = () => {// empty function\n};\n\nconst FEATURES_PROVIDER_CHANGE_WINDOW = \"directories=0,titlebar=0,toolbar=0,status=0,location=0,menubar=0,height=660,width=375\";\nconst FEATURES_DEFAULT_WALLET_WINDOW = \"directories=0,titlebar=0,toolbar=0,status=0,location=0,menubar=0,height=740,width=1315\";\nconst FEATURES_CONFIRM_WINDOW = \"directories=0,titlebar=0,toolbar=0,status=0,location=0,menubar=0,height=700,width=450\";\n\nfunction storageAvailable(type) {\n  let storage;\n\n  try {\n    storage = window[type];\n    const x = \"__storage_test__\";\n    storage.setItem(x, x);\n    storage.removeItem(x);\n    return true;\n  } catch (e) {\n    return e && ( // everything except Firefox\n    e.code === 22 || // Firefox\n    e.code === 1014 || // test name field too, because code might not be present\n    // everything except Firefox\n    e.name === \"QuotaExceededError\" || // Firefox\n    e.name === \"NS_ERROR_DOM_QUOTA_REACHED\") && // acknowledge QuotaExceededError only if there's something already stored\n    storage && storage.length !== 0;\n  }\n}\n\nfunction getPopupFeatures() {\n  // Fixes dual-screen position                             Most browsers      Firefox\n  const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;\n  const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;\n  const w = 1200;\n  const h = 700;\n  const width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : window.screen.width;\n  const height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : window.screen.height;\n  const systemZoom = 1; // No reliable estimate\n\n  const left = Math.abs((width - w) / 2 / systemZoom + dualScreenLeft);\n  const top = Math.abs((height - h) / 2 / systemZoom + dualScreenTop);\n  const features = \"titlebar=0,toolbar=0,status=0,location=0,menubar=0,height=\".concat(h / systemZoom, \",width=\").concat(w / systemZoom, \",top=\").concat(top, \",left=\").concat(left);\n  return features;\n}\n\nfunction ownKeys$1(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread$1(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys$1(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys$1(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\nSafeEventEmitter.defaultMaxListeners = 100; // resolve response.result, reject errors\n\nconst getRpcPromiseCallback = function (resolve, reject) {\n  let unwrapResult = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;\n  return (error, response) => {\n    if (error || response.error) {\n      return reject(error || response.error);\n    }\n\n    return !unwrapResult || Array.isArray(response) ? resolve(response) : resolve(response.result);\n  };\n};\n\nclass TorusInpageProvider extends SafeEventEmitter {\n  /**\n   * The chain ID of the currently connected Ethereum chain.\n   * See [chainId.network]{@link https://chainid.network} for more information.\n   */\n\n  /**\n   * The user's currently selected Ethereum address.\n   * If null, MetaMask is either locked or the user has not permitted any\n   * addresses to be viewed.\n   */\n\n  /**\n   * Indicating that this provider is a MetaMask provider.\n   */\n  constructor(connectionStream) {\n    let {\n      maxEventListeners = 100,\n      shouldSendMetadata = true,\n      jsonRpcStreamName = \"provider\"\n    } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    super();\n\n    _defineProperty(this, \"chainId\", void 0);\n\n    _defineProperty(this, \"selectedAddress\", void 0);\n\n    _defineProperty(this, \"_rpcEngine\", void 0);\n\n    _defineProperty(this, \"networkVersion\", void 0);\n\n    _defineProperty(this, \"shouldSendMetadata\", void 0);\n\n    _defineProperty(this, \"isTorus\", void 0);\n\n    _defineProperty(this, \"_publicConfigStore\", void 0);\n\n    _defineProperty(this, \"tryPreopenHandle\", void 0);\n\n    _defineProperty(this, \"enable\", void 0);\n\n    _defineProperty(this, \"_state\", void 0);\n\n    _defineProperty(this, \"_jsonRpcConnection\", void 0);\n\n    _defineProperty(this, \"_sentWarnings\", {\n      // methods\n      enable: false,\n      experimentalMethods: false,\n      send: false,\n      publicConfigStore: false,\n      // events\n      events: {\n        close: false,\n        data: false,\n        networkChanged: false,\n        notification: false\n      }\n    });\n\n    if (!isDuplexStream(connectionStream)) {\n      throw new Error(messages.errors.invalidDuplexStream());\n    }\n\n    this.isTorus = true;\n    this.setMaxListeners(maxEventListeners); // private state\n\n    this._state = _objectSpread$1({}, TorusInpageProvider._defaultState); // public state\n\n    this.selectedAddress = null;\n    this.networkVersion = null;\n    this.chainId = null;\n    this.shouldSendMetadata = shouldSendMetadata; // bind functions (to prevent e.g. web3@1.x from making unbound calls)\n\n    this._handleAccountsChanged = this._handleAccountsChanged.bind(this);\n    this._handleChainChanged = this._handleChainChanged.bind(this);\n    this._handleUnlockStateChanged = this._handleUnlockStateChanged.bind(this);\n    this._handleConnect = this._handleConnect.bind(this);\n    this._handleDisconnect = this._handleDisconnect.bind(this);\n    this._handleStreamDisconnect = this._handleStreamDisconnect.bind(this);\n    this._sendSync = this._sendSync.bind(this);\n    this._rpcRequest = this._rpcRequest.bind(this);\n    this._warnOfDeprecation = this._warnOfDeprecation.bind(this);\n    this._initializeState = this._initializeState.bind(this);\n    this.request = this.request.bind(this);\n    this.send = this.send.bind(this);\n    this.sendAsync = this.sendAsync.bind(this); // this.enable = this.enable.bind(this);\n    // setup connectionStream multiplexing\n\n    const mux = new ObjectMultiplex();\n    pump(connectionStream, mux, connectionStream, this._handleStreamDisconnect.bind(this, \"MetaMask\")); // subscribe to metamask public config (one-way)\n\n    this._publicConfigStore = new ObservableStore({\n      storageKey: \"Metamask-Config\"\n    }); // handle isUnlocked changes, and chainChanged and networkChanged events\n    // this._publicConfigStore.subscribe((stringifiedState) => {\n    //   // This is because we are using store as string\n    //   const state = JSON.parse(stringifiedState as unknown as string);\n    //   if (\"isUnlocked\" in state && state.isUnlocked !== this._state.isUnlocked) {\n    //     this._state.isUnlocked = state.isUnlocked;\n    //     if (!this._state.isUnlocked) {\n    //       // accounts are never exposed when the extension is locked\n    //       this._handleAccountsChanged([]);\n    //     } else {\n    //       // this will get the exposed accounts, if any\n    //       try {\n    //         this._rpcRequest(\n    //           { method: \"eth_accounts\", params: [] },\n    //           NOOP,\n    //           true // indicating that eth_accounts _should_ update accounts\n    //         );\n    //       } catch (_) {\n    //         // Swallow error\n    //       }\n    //     }\n    //   }\n    //   if (\"selectedAddress\" in state && this.selectedAddress !== state.selectedAddress) {\n    //     try {\n    //       this._rpcRequest(\n    //         { method: \"eth_accounts\", params: [] },\n    //         NOOP,\n    //         true // indicating that eth_accounts _should_ update accounts\n    //       );\n    //     } catch (_) {\n    //       // Swallow error\n    //     }\n    //   }\n    //   // Emit chainChanged event on chain change\n    //   if (\"chainId\" in state && state.chainId !== this.chainId) {\n    //     this.chainId = state.chainId || null;\n    //     this.emit(\"chainChanged\", this.chainId);\n    //     // indicate that we've connected, for EIP-1193 compliance\n    //     // we do this here so that iframe can initialize\n    //     if (!this._state.hasEmittedConnection) {\n    //       this._handleConnect(this.chainId);\n    //       this._state.hasEmittedConnection = true;\n    //     }\n    //   }\n    //   // Emit networkChanged event on network change\n    //   if (\"networkVersion\" in state && state.networkVersion !== this.networkVersion) {\n    //     this.networkVersion = state.networkVersion || null;\n    //     this.emit(\"networkChanged\", this.networkVersion);\n    //   }\n    // });\n\n    pump(mux.createStream(\"publicConfig\"), storeAsStream(this._publicConfigStore), // RPC requests should still work if only this stream fails\n    logStreamDisconnectWarning.bind(this, \"MetaMask PublicConfigStore\")); // ignore phishing warning message (handled elsewhere)\n\n    mux.ignoreStream(\"phishing\"); // setup own event listeners\n    // EIP-1193 connect\n\n    this.on(\"connect\", () => {\n      this._state.isConnected = true;\n    }); // connect to async provider\n\n    const jsonRpcConnection = createStreamMiddleware();\n    pump(jsonRpcConnection.stream, mux.createStream(jsonRpcStreamName), jsonRpcConnection.stream, this._handleStreamDisconnect.bind(this, \"MetaMask RpcProvider\")); // handle RPC requests via dapp-side rpc engine\n\n    const rpcEngine = new JRPCEngine();\n    rpcEngine.push(createIdRemapMiddleware());\n    rpcEngine.push(createErrorMiddleware());\n    rpcEngine.push(jsonRpcConnection.middleware);\n    this._rpcEngine = rpcEngine; // json rpc notification listener\n\n    jsonRpcConnection.events.on(\"notification\", payload => {\n      const {\n        method,\n        params\n      } = payload;\n\n      if (method === \"wallet_accountsChanged\") {\n        this._handleAccountsChanged(params);\n      } else if (method === \"wallet_unlockStateChanged\") {\n        this._handleUnlockStateChanged(params);\n      } else if (method === \"wallet_chainChanged\") {\n        this._handleChainChanged(params);\n      } else if (EMITTED_NOTIFICATIONS.includes(payload.method)) {\n        // EIP 1193 subscriptions, per eth-json-rpc-filters/subscriptionManager\n        this.emit(\"data\", payload); // deprecated\n\n        this.emit(\"notification\", params.result);\n        this.emit(\"message\", {\n          type: method,\n          data: params\n        });\n      } // Backward compatibility for older non EIP 1193 subscriptions\n      // this.emit('data', null, payload)\n\n    });\n  }\n\n  get publicConfigStore() {\n    if (!this._sentWarnings.publicConfigStore) {\n      log.warn(messages.warnings.publicConfigStore);\n      this._sentWarnings.publicConfigStore = true;\n    }\n\n    return this._publicConfigStore;\n  }\n  /**\n   * Returns whether the inpage provider is connected to Torus.\n   */\n\n\n  isConnected() {\n    return this._state.isConnected;\n  }\n  /**\n   * Submits an RPC request for the given method, with the given params.\n   * Resolves with the result of the method call, or rejects on error.\n   *\n   * @param args - The RPC request arguments.\n   * @returns A Promise that resolves with the result of the RPC method,\n   * or rejects if an error is encountered.\n   */\n\n\n  async request(args) {\n    if (!args || typeof args !== \"object\" || Array.isArray(args)) {\n      throw ethErrors.rpc.invalidRequest({\n        message: messages.errors.invalidRequestArgs(),\n        data: args\n      });\n    }\n\n    const {\n      method,\n      params\n    } = args;\n\n    if (typeof method !== \"string\" || method.length === 0) {\n      throw ethErrors.rpc.invalidRequest({\n        message: messages.errors.invalidRequestMethod(),\n        data: args\n      });\n    }\n\n    if (params !== undefined && !Array.isArray(params) && (typeof params !== \"object\" || params === null)) {\n      throw ethErrors.rpc.invalidRequest({\n        message: messages.errors.invalidRequestParams(),\n        data: args\n      });\n    }\n\n    return new Promise((resolve, reject) => {\n      this._rpcRequest({\n        method,\n        params\n      }, getRpcPromiseCallback(resolve, reject));\n    });\n  }\n  /**\n   * Submits an RPC request per the given JSON-RPC request object.\n   *\n   * @param payload - The RPC request object.\n   * @param cb - The callback function.\n   */\n\n\n  sendAsync(payload, callback) {\n    this._rpcRequest(payload, callback);\n  }\n  /**\n   * We override the following event methods so that we can warn consumers\n   * about deprecated events:\n   *   addListener, on, once, prependListener, prependOnceListener\n   */\n\n\n  addListener(eventName, listener) {\n    this._warnOfDeprecation(eventName);\n\n    return super.addListener(eventName, listener);\n  }\n\n  on(eventName, listener) {\n    this._warnOfDeprecation(eventName);\n\n    return super.on(eventName, listener);\n  }\n\n  once(eventName, listener) {\n    this._warnOfDeprecation(eventName);\n\n    return super.once(eventName, listener);\n  }\n\n  prependListener(eventName, listener) {\n    this._warnOfDeprecation(eventName);\n\n    return super.prependListener(eventName, listener);\n  }\n\n  prependOnceListener(eventName, listener) {\n    this._warnOfDeprecation(eventName);\n\n    return super.prependOnceListener(eventName, listener);\n  } // Private Methods\n  //= ===================\n\n  /**\n   * Constructor helper.\n   * Populates initial state by calling 'wallet_getProviderState' and emits\n   * necessary events.\n   */\n\n\n  async _initializeState() {\n    try {\n      const {\n        accounts,\n        chainId,\n        isUnlocked,\n        networkVersion\n      } = await this.request({\n        method: \"wallet_getProviderState\"\n      }); // indicate that we've connected, for EIP-1193 compliance\n\n      this.emit(\"connect\", {\n        chainId\n      });\n\n      this._handleChainChanged({\n        chainId,\n        networkVersion\n      });\n\n      this._handleUnlockStateChanged({\n        accounts,\n        isUnlocked\n      });\n\n      this._handleAccountsChanged(accounts);\n    } catch (error) {\n      log.error(\"MetaMask: Failed to get initial state. Please report this bug.\", error);\n    } finally {\n      log.info(\"initialized state\");\n      this._state.initialized = true;\n      this.emit(\"_initialized\");\n    }\n  }\n  /**\n   * Internal RPC method. Forwards requests to background via the RPC engine.\n   * Also remap ids inbound and outbound.\n   *\n   * @param payload - The RPC request object.\n   * @param callback - The consumer's callback.\n   * @param isInternal - false - Whether the request is internal.\n   */\n\n\n  _rpcRequest(payload, callback) {\n    let isInternal = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    let cb = callback;\n    const _payload = payload;\n\n    if (!Array.isArray(_payload)) {\n      if (!_payload.jsonrpc) {\n        _payload.jsonrpc = \"2.0\";\n      }\n\n      if (_payload.method === \"eth_accounts\" || _payload.method === \"eth_requestAccounts\") {\n        // handle accounts changing\n        cb = (err, res) => {\n          this._handleAccountsChanged(res.result || [], _payload.method === \"eth_accounts\", isInternal);\n\n          callback(err, res);\n        };\n      } else if (_payload.method === \"wallet_getProviderState\") {\n        this._rpcEngine.handle(payload, cb);\n\n        return;\n      }\n    }\n\n    this.tryPreopenHandle(_payload, cb);\n  }\n\n  send(methodOrPayload, callbackOrArgs) {\n    if (!this._sentWarnings.send) {\n      log.warn(messages.warnings.sendDeprecation);\n      this._sentWarnings.send = true;\n    }\n\n    if (typeof methodOrPayload === \"string\" && (!callbackOrArgs || Array.isArray(callbackOrArgs))) {\n      return new Promise((resolve, reject) => {\n        try {\n          this._rpcRequest({\n            method: methodOrPayload,\n            params: callbackOrArgs\n          }, getRpcPromiseCallback(resolve, reject, false));\n        } catch (error) {\n          reject(error);\n        }\n      });\n    }\n\n    if (methodOrPayload && typeof methodOrPayload === \"object\" && typeof callbackOrArgs === \"function\") {\n      return this._rpcRequest(methodOrPayload, callbackOrArgs);\n    }\n\n    return this._sendSync(methodOrPayload);\n  }\n  /**\n   * DEPRECATED.\n   * Internal backwards compatibility method, used in send.\n   */\n\n\n  _sendSync(payload) {\n    let result;\n\n    switch (payload.method) {\n      case \"eth_accounts\":\n        result = this.selectedAddress ? [this.selectedAddress] : [];\n        break;\n\n      case \"eth_coinbase\":\n        result = this.selectedAddress || null;\n        break;\n\n      case \"eth_uninstallFilter\":\n        this._rpcRequest(payload, NOOP);\n\n        result = true;\n        break;\n\n      case \"net_version\":\n        result = this.networkVersion || null;\n        break;\n\n      default:\n        throw new Error(messages.errors.unsupportedSync(payload.method));\n    }\n\n    return {\n      id: payload.id,\n      jsonrpc: payload.jsonrpc,\n      result\n    };\n  }\n  /**\n   * When the provider becomes connected, updates internal state and emits\n   * required events. Idempotent.\n   *\n   * @param chainId - The ID of the newly connected chain.\n   * emits MetaMaskInpageProvider#connect\n   */\n\n\n  _handleConnect(chainId) {\n    if (!this._state.isConnected) {\n      this._state.isConnected = true;\n      this.emit(\"connect\", {\n        chainId\n      });\n      log.debug(messages.info.connected(chainId));\n    }\n  }\n  /**\n   * When the provider becomes disconnected, updates internal state and emits\n   * required events. Idempotent with respect to the isRecoverable parameter.\n   *\n   * Error codes per the CloseEvent status codes as required by EIP-1193:\n   * https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent#Status_codes\n   *\n   * @param isRecoverable - Whether the disconnection is recoverable.\n   * @param errorMessage - A custom error message.\n   * emits MetaMaskInpageProvider#disconnect\n   */\n\n\n  _handleDisconnect(isRecoverable, errorMessage) {\n    if (this._state.isConnected || !this._state.isPermanentlyDisconnected && !isRecoverable) {\n      this._state.isConnected = false;\n      let error;\n\n      if (isRecoverable) {\n        error = new EthereumRpcError(1013, // Try again later\n        errorMessage || messages.errors.disconnected());\n        log.debug(error);\n      } else {\n        error = new EthereumRpcError(1011, // Internal error\n        errorMessage || messages.errors.permanentlyDisconnected());\n        log.error(error);\n        this.chainId = null;\n        this._state.accounts = null;\n        this.selectedAddress = null;\n        this._state.isUnlocked = false;\n        this._state.isPermanentlyDisconnected = true;\n      }\n\n      this.emit(\"disconnect\", error);\n    }\n  }\n  /**\n   * Called when connection is lost to critical streams.\n   *\n   * emits MetamaskInpageProvider#disconnect\n   */\n\n\n  _handleStreamDisconnect(streamName, error) {\n    logStreamDisconnectWarning(streamName, error, this);\n\n    this._handleDisconnect(false, error ? error.message : undefined);\n  }\n  /**\n   * Called when accounts may have changed.\n   */\n\n\n  _handleAccountsChanged(accounts) {\n    let isEthAccounts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    let isInternal = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false; // defensive programming\n\n    let finalAccounts = accounts;\n\n    if (!Array.isArray(finalAccounts)) {\n      log.error(\"MetaMask: Received non-array accounts parameter. Please report this bug.\", finalAccounts);\n      finalAccounts = [];\n    }\n\n    for (const account of accounts) {\n      if (typeof account !== \"string\") {\n        log.error(\"MetaMask: Received non-string account. Please report this bug.\", accounts);\n        finalAccounts = [];\n        break;\n      }\n    } // emit accountsChanged if anything about the accounts array has changed\n\n\n    if (!dequal(this._state.accounts, finalAccounts)) {\n      // we should always have the correct accounts even before eth_accounts\n      // returns, except in cases where isInternal is true\n      if (isEthAccounts && Array.isArray(this._state.accounts) && this._state.accounts.length > 0 && !isInternal) {\n        log.error('MetaMask: \"eth_accounts\" unexpectedly updated accounts. Please report this bug.', finalAccounts);\n      }\n\n      this._state.accounts = finalAccounts;\n      this.emit(\"accountsChanged\", finalAccounts);\n    } // handle selectedAddress\n\n\n    if (this.selectedAddress !== finalAccounts[0]) {\n      this.selectedAddress = finalAccounts[0] || null;\n    }\n  }\n  /**\n   * Upon receipt of a new chainId and networkVersion, emits corresponding\n   * events and sets relevant public state.\n   * Does nothing if neither the chainId nor the networkVersion are different\n   * from existing values.\n   *\n   * emits MetamaskInpageProvider#chainChanged\n   * @param networkInfo - An object with network info.\n   */\n\n\n  _handleChainChanged() {\n    let {\n      chainId,\n      networkVersion\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    if (!chainId || !networkVersion) {\n      log.error(\"MetaMask: Received invalid network parameters. Please report this bug.\", {\n        chainId,\n        networkVersion\n      });\n      return;\n    }\n\n    if (networkVersion === \"loading\") {\n      this._handleDisconnect(true);\n    } else {\n      this._handleConnect(chainId);\n\n      if (chainId !== this.chainId) {\n        this.chainId = chainId;\n\n        if (this._state.initialized) {\n          this.emit(\"chainChanged\", this.chainId);\n        }\n      }\n    }\n  }\n  /**\n   * Upon receipt of a new isUnlocked state, sets relevant public state.\n   * Calls the accounts changed handler with the received accounts, or an empty\n   * array.\n   *\n   * Does nothing if the received value is equal to the existing value.\n   * There are no lock/unlock events.\n   *\n   * @param opts - Options bag.\n   */\n\n\n  _handleUnlockStateChanged() {\n    let {\n      accounts,\n      isUnlocked\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    if (typeof isUnlocked !== \"boolean\") {\n      log.error(\"MetaMask: Received invalid isUnlocked parameter. Please report this bug.\", {\n        isUnlocked\n      });\n      return;\n    }\n\n    if (isUnlocked !== this._state.isUnlocked) {\n      this._state.isUnlocked = isUnlocked;\n\n      this._handleAccountsChanged(accounts || []);\n    }\n  }\n  /**\n   * Warns of deprecation for the given event, if applicable.\n   */\n\n\n  _warnOfDeprecation(eventName) {\n    if (this._sentWarnings.events[eventName] === false) {\n      log.warn(messages.warnings.events[eventName]);\n      this._sentWarnings.events[eventName] = true;\n    }\n  }\n\n}\n\n_defineProperty(TorusInpageProvider, \"_defaultState\", {\n  accounts: null,\n  isConnected: false,\n  isUnlocked: false,\n  initialized: false,\n  isPermanentlyDisconnected: false,\n  hasEmittedConnection: false\n});\n\nconst defaults = options => ({\n  algorithms: options.algorithms || [\"sha256\"],\n  delimiter: options.delimiter || \" \",\n  full: options.full || false\n}); // Generate list of hashes\n\n\nconst hashes = (options, data) => {\n  const internalHashes = {};\n  options.algorithms.forEach(algorithm => {\n    internalHashes[algorithm] = createHash(algorithm).update(data, \"utf8\").digest(\"base64\");\n  });\n  return internalHashes;\n}; // Build an integrity string\n\n\nconst integrity = (options, sri) => {\n  let output = \"\"; // Hash list\n\n  output += Object.keys(sri.hashes).map(algorithm => \"\".concat(algorithm, \"-\").concat(sri.hashes[algorithm])).join(options.delimiter);\n  return output;\n};\n\nconst main = (options, data) => {\n  // Defaults\n  const finalOptions = defaults(options);\n  const sri = {\n    hashes: hashes(finalOptions, data),\n    integrity: undefined\n  };\n  sri.integrity = integrity(finalOptions, sri);\n  return finalOptions.full ? sri : sri.integrity;\n};\n\nclass PopupHandler extends EventEmitter {\n  constructor(_ref) {\n    let {\n      url,\n      target,\n      features\n    } = _ref;\n    super();\n\n    _defineProperty(this, \"url\", void 0);\n\n    _defineProperty(this, \"target\", void 0);\n\n    _defineProperty(this, \"features\", void 0);\n\n    _defineProperty(this, \"window\", void 0);\n\n    _defineProperty(this, \"windowTimer\", void 0);\n\n    _defineProperty(this, \"iClosedWindow\", void 0);\n\n    this.url = url;\n    this.target = target || \"_blank\";\n    this.features = features || getPopupFeatures();\n    this.window = undefined;\n    this.windowTimer = undefined;\n    this.iClosedWindow = false;\n\n    this._setupTimer();\n  }\n\n  _setupTimer() {\n    this.windowTimer = Number(setInterval(() => {\n      if (this.window && this.window.closed) {\n        clearInterval(this.windowTimer);\n\n        if (!this.iClosedWindow) {\n          this.emit(\"close\");\n        }\n\n        this.iClosedWindow = false;\n        this.window = undefined;\n      }\n\n      if (this.window === undefined) clearInterval(this.windowTimer);\n    }, 500));\n  }\n\n  open() {\n    var _this$window;\n\n    this.window = window.open(this.url.href, this.target, this.features);\n    if ((_this$window = this.window) !== null && _this$window !== void 0 && _this$window.focus) this.window.focus();\n    return Promise.resolve();\n  }\n\n  close() {\n    this.iClosedWindow = true;\n    if (this.window) this.window.close();\n  }\n\n  redirect(locationReplaceOnRedirect) {\n    if (locationReplaceOnRedirect) {\n      window.location.replace(this.url.href);\n    } else {\n      window.location.href = this.url.href;\n    }\n  }\n\n}\n/**\n * Returns whether the given image URL exists\n * @param url - the url of the image\n * @returns - whether the image exists\n */\n\n\nfunction imgExists(url) {\n  return new Promise((resolve, reject) => {\n    try {\n      const img = document.createElement(\"img\");\n\n      img.onload = () => resolve(true);\n\n      img.onerror = () => resolve(false);\n\n      img.src = url;\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n/**\n * Extracts a name for the site from the DOM\n */\n\n\nconst getSiteName = window => {\n  const {\n    document\n  } = window;\n  const siteName = document.querySelector('head > meta[property=\"og:site_name\"]');\n\n  if (siteName) {\n    return siteName.content;\n  }\n\n  const metaTitle = document.querySelector('head > meta[name=\"title\"]');\n\n  if (metaTitle) {\n    return metaTitle.content;\n  }\n\n  if (document.title && document.title.length > 0) {\n    return document.title;\n  }\n\n  return window.location.hostname;\n};\n/**\n * Extracts an icon for the site from the DOM\n */\n\n\nasync function getSiteIcon(window) {\n  const {\n    document\n  } = window; // Use the site's favicon if it exists\n\n  let icon = document.querySelector('head > link[rel=\"shortcut icon\"]');\n\n  if (icon && (await imgExists(icon.href))) {\n    return icon.href;\n  } // Search through available icons in no particular order\n\n\n  icon = Array.from(document.querySelectorAll('head > link[rel=\"icon\"]')).find(_icon => Boolean(_icon.href));\n\n  if (icon && (await imgExists(icon.href))) {\n    return icon.href;\n  }\n\n  return null;\n}\n/**\n * Gets site metadata and returns it\n *\n */\n\n\nconst getSiteMetadata = async () => ({\n  name: getSiteName(window),\n  icon: await getSiteIcon(window)\n});\n/**\n * Sends site metadata over an RPC request.\n */\n\n\nasync function sendSiteMetadata(engine) {\n  try {\n    const domainMetadata = await getSiteMetadata(); // call engine.handle directly to avoid normal RPC request handling\n\n    engine.handle({\n      jsonrpc: \"2.0\",\n      id: getPreopenInstanceId(),\n      method: \"wallet_sendDomainMetadata\",\n      params: domainMetadata\n    }, NOOP);\n  } catch (error) {\n    log.error({\n      message: messages.errors.sendSiteMetadata(),\n      originalError: error\n    });\n  }\n}\n\nconst _excluded = [\"host\", \"chainId\", \"networkName\"];\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\nconst defaultVerifiers = {\n  [LOGIN_PROVIDER.GOOGLE]: true,\n  [LOGIN_PROVIDER.FACEBOOK]: true,\n  [LOGIN_PROVIDER.REDDIT]: true,\n  [LOGIN_PROVIDER.TWITCH]: true,\n  [LOGIN_PROVIDER.DISCORD]: true\n};\nconst iframeIntegrity = \"sha384-I1qqxsIO3trXzTO78PZoXvNamECKTo3uCnztKxjV0MmFWtmZY3uBpnJlhO7z/WBw\";\nconst expectedCacheControlHeader = \"max-age=3600\";\nconst UNSAFE_METHODS = [\"eth_sendTransaction\", \"eth_signTypedData\", \"eth_signTypedData_v3\", \"eth_signTypedData_v4\", \"personal_sign\", \"eth_getEncryptionPublicKey\", \"eth_decrypt\"];\nconst isLocalStorageAvailable = storageAvailable(\"localStorage\"); // preload for iframe doesn't work https://bugs.chromium.org/p/chromium/issues/detail?id=593267\n\n(async function preLoadIframe() {\n  try {\n    if (typeof document === \"undefined\") return;\n    const torusIframeHtml = document.createElement(\"link\");\n    const {\n      torusUrl\n    } = await getTorusUrl(\"production\", {\n      check: false,\n      hash: iframeIntegrity,\n      version: \"\"\n    });\n    torusIframeHtml.href = \"\".concat(torusUrl, \"/popup\");\n    torusIframeHtml.crossOrigin = \"anonymous\";\n    torusIframeHtml.type = \"text/html\";\n    torusIframeHtml.rel = \"prefetch\";\n\n    if (torusIframeHtml.relList && torusIframeHtml.relList.supports) {\n      if (torusIframeHtml.relList.supports(\"prefetch\")) {\n        document.head.appendChild(torusIframeHtml);\n      }\n    }\n  } catch (error) {\n    log.warn(error);\n  }\n})();\n\nclass Torus {\n  constructor() {\n    let {\n      buttonPosition = BUTTON_POSITION.BOTTOM_LEFT,\n      modalZIndex = 99999,\n      apiKey = \"torus-default\"\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _defineProperty(this, \"buttonPosition\", BUTTON_POSITION.BOTTOM_LEFT);\n\n    _defineProperty(this, \"torusUrl\", void 0);\n\n    _defineProperty(this, \"torusIframe\", void 0);\n\n    _defineProperty(this, \"styleLink\", void 0);\n\n    _defineProperty(this, \"isLoggedIn\", void 0);\n\n    _defineProperty(this, \"isInitialized\", void 0);\n\n    _defineProperty(this, \"torusWidgetVisibility\", void 0);\n\n    _defineProperty(this, \"torusAlert\", void 0);\n\n    _defineProperty(this, \"nodeDetailManager\", void 0);\n\n    _defineProperty(this, \"torusJs\", void 0);\n\n    _defineProperty(this, \"apiKey\", void 0);\n\n    _defineProperty(this, \"modalZIndex\", void 0);\n\n    _defineProperty(this, \"alertZIndex\", void 0);\n\n    _defineProperty(this, \"torusAlertContainer\", void 0);\n\n    _defineProperty(this, \"isIframeFullScreen\", void 0);\n\n    _defineProperty(this, \"whiteLabel\", void 0);\n\n    _defineProperty(this, \"requestedVerifier\", void 0);\n\n    _defineProperty(this, \"currentVerifier\", void 0);\n\n    _defineProperty(this, \"embedTranslations\", void 0);\n\n    _defineProperty(this, \"ethereum\", void 0);\n\n    _defineProperty(this, \"provider\", void 0);\n\n    _defineProperty(this, \"communicationMux\", void 0);\n\n    _defineProperty(this, \"isLoginCallback\", void 0);\n\n    _defineProperty(this, \"dappStorageKey\", void 0);\n\n    _defineProperty(this, \"paymentProviders\", configuration.paymentProviders);\n\n    _defineProperty(this, \"loginHint\", \"\");\n\n    _defineProperty(this, \"useWalletConnect\", void 0);\n\n    this.buttonPosition = buttonPosition;\n    this.torusUrl = \"\";\n    this.isLoggedIn = false; // ethereum.enable working\n\n    this.isInitialized = false; // init done\n\n    this.torusWidgetVisibility = true;\n    this.requestedVerifier = \"\";\n    this.currentVerifier = \"\";\n    this.nodeDetailManager = new NodeDetailManager();\n    this.torusJs = new TorusJs({\n      metadataHost: \"https://metadata.tor.us\",\n      allowHost: \"https://signer.tor.us/api/allow\"\n    });\n    this.apiKey = apiKey;\n    TorusJs.setAPIKey(apiKey);\n    setAPIKey(apiKey);\n    this.modalZIndex = modalZIndex;\n    this.alertZIndex = modalZIndex + 1000;\n    this.isIframeFullScreen = false;\n    this.dappStorageKey = \"\";\n  }\n\n  async init() {\n    let {\n      buildEnv = TORUS_BUILD_ENV.PRODUCTION,\n      enableLogging = false,\n      // deprecated: use loginConfig instead\n      enabledVerifiers = defaultVerifiers,\n      network = {\n        host: \"mainnet\",\n        chainId: null,\n        networkName: \"\",\n        blockExplorer: \"\",\n        ticker: \"\",\n        tickerName: \"\"\n      },\n      loginConfig = {},\n      showTorusButton = true,\n      integrity = {\n        check: false,\n        hash: iframeIntegrity,\n        version: \"\"\n      },\n      whiteLabel,\n      skipTKey = false,\n      useLocalStorage = false,\n      useWalletConnect = false\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    if (this.isInitialized) throw new Error(\"Already initialized\");\n    const {\n      torusUrl,\n      logLevel\n    } = await getTorusUrl(buildEnv, integrity);\n    log.info(torusUrl, \"url loaded\");\n    this.torusUrl = torusUrl;\n    this.whiteLabel = whiteLabel;\n    this.useWalletConnect = useWalletConnect;\n    log.setDefaultLevel(logLevel);\n    if (enableLogging) log.enableAll();else log.disableAll();\n    this.torusWidgetVisibility = showTorusButton;\n    let dappStorageKey = \"\";\n\n    if (isLocalStorageAvailable && useLocalStorage) {\n      const storedKey = window.localStorage.getItem(configuration.localStorageKey);\n      if (storedKey) dappStorageKey = storedKey;else {\n        const generatedKey = \"torus-app-\".concat(getPreopenInstanceId());\n        window.localStorage.setItem(configuration.localStorageKey, generatedKey);\n        dappStorageKey = generatedKey;\n      }\n    }\n\n    this.dappStorageKey = dappStorageKey;\n    const torusIframeUrl = new URL(torusUrl);\n    if (torusIframeUrl.pathname.endsWith(\"/\")) torusIframeUrl.pathname += \"popup\";else torusIframeUrl.pathname += \"/popup\";\n\n    if (dappStorageKey) {\n      torusIframeUrl.hash = \"#dappStorageKey=\".concat(dappStorageKey);\n    } // Iframe code\n\n\n    this.torusIframe = htmlToElement(\"<iframe\\n        id=\\\"torusIframe\\\"\\n        allow=\".concat(useWalletConnect ? \"camera\" : \"\", \"\\n        class=\\\"torusIframe\\\"\\n        src=\\\"\").concat(torusIframeUrl.href, \"\\\"\\n        style=\\\"display: none; position: fixed; top: 0; right: 0; width: 100%;\\n        height: 100%; border: none; border-radius: 0; z-index: \").concat(this.modalZIndex, \"\\\"\\n      ></iframe>\"));\n    this.torusAlertContainer = htmlToElement('<div id=\"torusAlertContainer\"></div>');\n    this.torusAlertContainer.style.display = \"none\";\n    this.torusAlertContainer.style.setProperty(\"z-index\", this.alertZIndex.toString());\n    const link = window.document.createElement(\"link\");\n    link.setAttribute(\"rel\", \"stylesheet\");\n    link.setAttribute(\"type\", \"text/css\");\n    link.setAttribute(\"href\", \"\".concat(torusUrl, \"/css/widget.css\"));\n    this.styleLink = link;\n    const {\n      defaultLanguage = getUserLanguage(),\n      customTranslations = {}\n    } = this.whiteLabel || {};\n    const mergedTranslations = deepmerge(configuration.translations, customTranslations);\n    const languageTranslations = mergedTranslations[defaultLanguage] || configuration.translations[getUserLanguage()];\n    this.embedTranslations = languageTranslations.embed;\n\n    const handleSetup = async () => {\n      await documentReady();\n      return new Promise((resolve, reject) => {\n        this.torusIframe.onload = async () => {\n          // only do this if iframe is not full screen\n          this._setupWeb3();\n\n          const initStream = this.communicationMux.getStream(\"init_stream\");\n          initStream.on(\"data\", chunk => {\n            const {\n              name,\n              data,\n              error\n            } = chunk;\n\n            if (name === \"init_complete\" && data.success) {\n              // resolve promise\n              this.isInitialized = true;\n\n              this._displayIframe(this.isIframeFullScreen);\n\n              resolve(undefined);\n            } else if (error) {\n              reject(new Error(error));\n            }\n          });\n          initStream.write({\n            name: \"init_stream\",\n            data: {\n              enabledVerifiers,\n              loginConfig,\n              whiteLabel: this.whiteLabel,\n              buttonPosition: this.buttonPosition,\n              torusWidgetVisibility: this.torusWidgetVisibility,\n              apiKey: this.apiKey,\n              skipTKey,\n              network\n            }\n          });\n        };\n\n        window.document.head.appendChild(this.styleLink);\n        window.document.body.appendChild(this.torusIframe);\n        window.document.body.appendChild(this.torusAlertContainer);\n      });\n    };\n\n    if (buildEnv === \"production\" && integrity.check) {\n      // hacky solution to check for iframe integrity\n      const fetchUrl = \"\".concat(torusUrl, \"/popup\");\n      const resp = await fetch(fetchUrl, {\n        cache: \"reload\"\n      });\n\n      if (resp.headers.get(\"Cache-Control\") !== expectedCacheControlHeader) {\n        throw new Error(\"Unexpected Cache-Control headers, got \".concat(resp.headers.get(\"Cache-Control\")));\n      }\n\n      const response = await resp.text();\n      const calculatedIntegrity = main({\n        algorithms: [\"sha384\"]\n      }, response);\n      log.info(calculatedIntegrity, \"integrity\");\n\n      if (calculatedIntegrity === integrity.hash) {\n        await handleSetup();\n      } else {\n        this.clearInit();\n        throw new Error(\"Integrity check failed\");\n      }\n    } else {\n      await handleSetup();\n    }\n\n    return undefined;\n  }\n\n  login() {\n    let {\n      verifier = \"\",\n      login_hint: loginHint = \"\"\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    if (!this.isInitialized) throw new Error(\"Call init() first\");\n    this.requestedVerifier = verifier;\n    this.loginHint = loginHint;\n    return this.ethereum.enable();\n  }\n\n  logout() {\n    return new Promise((resolve, reject) => {\n      if (!this.isLoggedIn) {\n        reject(new Error(\"User has not logged in yet\"));\n        return;\n      }\n\n      const logOutStream = this.communicationMux.getStream(\"logout\");\n      logOutStream.write({\n        name: \"logOut\"\n      });\n      const statusStream = this.communicationMux.getStream(\"status\");\n\n      const statusStreamHandler = status => {\n        if (!status.loggedIn) {\n          this.isLoggedIn = false;\n          this.currentVerifier = \"\";\n          this.requestedVerifier = \"\";\n          resolve();\n        } else reject(new Error(\"Some Error Occured\"));\n      };\n\n      handleStream(statusStream, \"data\", statusStreamHandler);\n    });\n  }\n\n  async cleanUp() {\n    if (this.isLoggedIn) {\n      await this.logout();\n    }\n\n    this.clearInit();\n  }\n\n  clearInit() {\n    function isElement(element) {\n      return element instanceof Element || element instanceof HTMLDocument;\n    }\n\n    if (isElement(this.styleLink) && window.document.body.contains(this.styleLink)) {\n      this.styleLink.remove();\n      this.styleLink = undefined;\n    }\n\n    if (isElement(this.torusIframe) && window.document.body.contains(this.torusIframe)) {\n      this.torusIframe.remove();\n      this.torusIframe = undefined;\n    }\n\n    if (isElement(this.torusAlertContainer) && window.document.body.contains(this.torusAlertContainer)) {\n      this.torusAlert = undefined;\n      this.torusAlertContainer.remove();\n      this.torusAlertContainer = undefined;\n    }\n\n    this.isInitialized = false;\n  }\n\n  hideTorusButton() {\n    this.torusWidgetVisibility = false;\n\n    this._sendWidgetVisibilityStatus(false);\n\n    this._displayIframe();\n  }\n\n  showTorusButton() {\n    this.torusWidgetVisibility = true;\n\n    this._sendWidgetVisibilityStatus(true);\n\n    this._displayIframe();\n  }\n\n  setProvider() {\n    let _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    let {\n      host = \"mainnet\",\n      chainId = null,\n      networkName = \"\"\n    } = _ref,\n        rest = _objectWithoutProperties(_ref, _excluded);\n\n    return new Promise((resolve, reject) => {\n      const providerChangeStream = this.communicationMux.getStream(\"provider_change\");\n\n      const handler = chunk => {\n        const {\n          err,\n          success\n        } = chunk.data;\n        log.info(chunk);\n\n        if (err) {\n          reject(err);\n        } else if (success) {\n          resolve();\n        } else reject(new Error(\"some error occured\"));\n      };\n\n      handleStream(providerChangeStream, \"data\", handler);\n      const preopenInstanceId = getPreopenInstanceId();\n\n      this._handleWindow(preopenInstanceId, {\n        target: \"_blank\",\n        features: FEATURES_PROVIDER_CHANGE_WINDOW\n      });\n\n      providerChangeStream.write({\n        name: \"show_provider_change\",\n        data: {\n          network: _objectSpread({\n            host,\n            chainId,\n            networkName\n          }, rest),\n          preopenInstanceId,\n          override: false\n        }\n      });\n    });\n  }\n\n  showWallet(path) {\n    let params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    const showWalletStream = this.communicationMux.getStream(\"show_wallet\");\n    const finalPath = path ? \"/\".concat(path) : \"\";\n    showWalletStream.write({\n      name: \"show_wallet\",\n      data: {\n        path: finalPath\n      }\n    });\n\n    const showWalletHandler = chunk => {\n      if (chunk.name === \"show_wallet_instance\") {\n        // Let the error propogate up (hence, no try catch)\n        const {\n          instanceId\n        } = chunk.data;\n        const finalUrl = new URL(\"\".concat(this.torusUrl, \"/wallet\").concat(finalPath)); // Using URL constructor to prevent js injection and allow parameter validation.!\n\n        finalUrl.searchParams.append(\"integrity\", \"true\");\n        finalUrl.searchParams.append(\"instanceId\", instanceId);\n        Object.keys(params).forEach(x => {\n          finalUrl.searchParams.append(x, params[x]);\n        });\n\n        if (this.dappStorageKey) {\n          finalUrl.hash = \"#dappStorageKey=\".concat(this.dappStorageKey);\n        }\n\n        const walletWindow = new PopupHandler({\n          url: finalUrl,\n          features: FEATURES_DEFAULT_WALLET_WINDOW\n        });\n        walletWindow.open();\n      }\n    };\n\n    handleStream(showWalletStream, \"data\", showWalletHandler);\n  }\n\n  async getPublicAddress(_ref2) {\n    let {\n      verifier,\n      verifierId,\n      isExtended = false\n    } = _ref2;\n    if (!configuration.supportedVerifierList.includes(verifier) || !WALLET_OPENLOGIN_VERIFIER_MAP[verifier]) throw new Error(\"Unsupported verifier\");\n    const nodeDetails = await this.nodeDetailManager.getNodeDetails({\n      verifier,\n      verifierId\n    });\n    const endpoints = nodeDetails.torusNodeEndpoints;\n    const torusNodePubs = nodeDetails.torusNodePub;\n    const walletVerifier = verifier;\n    const openloginVerifier = WALLET_OPENLOGIN_VERIFIER_MAP[verifier];\n\n    try {\n      const existingV1User = await this.torusJs.getUserTypeAndAddress(endpoints, torusNodePubs, {\n        verifier: walletVerifier,\n        verifierId\n      });\n\n      if (existingV1User.typeOfUser === \"v1\") {\n        if (!isExtended) return existingV1User.address;\n        return existingV1User;\n      } // we don't support v2 users with v1 verifiers so get or assign the key for v2 user on v2 `verifier`\n\n\n      const v2User = await this.torusJs.getUserTypeAndAddress(endpoints, torusNodePubs, {\n        verifier: openloginVerifier,\n        verifierId\n      }, true);\n      if (!isExtended) return v2User.address;\n      return v2User;\n    } catch (error) {\n      if (error !== null && error !== void 0 && error.message.includes(\"Verifier + VerifierID has not yet been assigned\")) {\n        // if user doesn't have key then assign it with v2 verifier\n        const newV2User = await this.torusJs.getUserTypeAndAddress(endpoints, torusNodePubs, {\n          verifier: openloginVerifier,\n          verifierId\n        }, true);\n        if (!isExtended) return newV2User.address;\n        return newV2User;\n      }\n\n      throw error;\n    }\n  }\n\n  getUserInfo(message) {\n    return new Promise((resolve, reject) => {\n      if (this.isLoggedIn) {\n        const userInfoAccessStream = this.communicationMux.getStream(\"user_info_access\");\n        userInfoAccessStream.write({\n          name: \"user_info_access_request\"\n        });\n\n        const userInfoAccessHandler = chunk => {\n          const {\n            name,\n            data: {\n              approved,\n              payload,\n              rejected,\n              newRequest\n            }\n          } = chunk;\n\n          if (name === \"user_info_access_response\") {\n            if (approved) {\n              resolve(payload);\n            } else if (rejected) {\n              reject(new Error(\"User rejected the request\"));\n            } else if (newRequest) {\n              const userInfoStream = this.communicationMux.getStream(\"user_info\");\n\n              const userInfoHandler = handlerChunk => {\n                if (handlerChunk.name === \"user_info_response\") {\n                  if (handlerChunk.data.approved) {\n                    resolve(handlerChunk.data.payload);\n                  } else {\n                    reject(new Error(\"User rejected the request\"));\n                  }\n                }\n              };\n\n              handleStream(userInfoStream, \"data\", userInfoHandler);\n              const preopenInstanceId = getPreopenInstanceId();\n\n              this._handleWindow(preopenInstanceId, {\n                target: \"_blank\",\n                features: FEATURES_PROVIDER_CHANGE_WINDOW\n              });\n\n              userInfoStream.write({\n                name: \"user_info_request\",\n                data: {\n                  message,\n                  preopenInstanceId\n                }\n              });\n            }\n          }\n        };\n\n        handleStream(userInfoAccessStream, \"data\", userInfoAccessHandler);\n      } else reject(new Error(\"User has not logged in yet\"));\n    });\n  }\n\n  initiateTopup(provider, params) {\n    return new Promise((resolve, reject) => {\n      if (this.isInitialized) {\n        const {\n          errors,\n          isValid\n        } = validatePaymentProvider(provider, params);\n\n        if (!isValid) {\n          reject(new Error(JSON.stringify(errors)));\n          return;\n        }\n\n        const topupStream = this.communicationMux.getStream(\"topup\");\n\n        const topupHandler = chunk => {\n          if (chunk.name === \"topup_response\") {\n            if (chunk.data.success) {\n              resolve(chunk.data.success);\n            } else {\n              reject(new Error(chunk.data.error));\n            }\n          }\n        };\n\n        handleStream(topupStream, \"data\", topupHandler);\n        const preopenInstanceId = getPreopenInstanceId();\n\n        this._handleWindow(preopenInstanceId);\n\n        topupStream.write({\n          name: \"topup_request\",\n          data: {\n            provider,\n            params,\n            preopenInstanceId\n          }\n        });\n      } else reject(new Error(\"Torus is not initialized yet\"));\n    });\n  }\n\n  async loginWithPrivateKey(loginParams) {\n    const {\n      privateKey,\n      userInfo\n    } = loginParams;\n    return new Promise((resolve, reject) => {\n      if (this.isInitialized) {\n        if (Buffer.from(privateKey, \"hex\").length !== 32) {\n          reject(new Error(\"Invalid private key, Please provide a 32 byte valid secp25k1 private key\"));\n          return;\n        }\n\n        const loginPrivKeyStream = this.communicationMux.getStream(\"login_with_private_key\");\n\n        const loginHandler = chunk => {\n          if (chunk.name === \"login_with_private_key_response\") {\n            if (chunk.data.success) {\n              resolve(chunk.data.success);\n            } else {\n              reject(new Error(chunk.data.error));\n            }\n          }\n        };\n\n        handleStream(loginPrivKeyStream, \"data\", loginHandler);\n        loginPrivKeyStream.write({\n          name: \"login_with_private_key_request\",\n          data: {\n            privateKey,\n            userInfo\n          }\n        });\n      } else reject(new Error(\"Torus is not initialized yet\"));\n    });\n  }\n\n  async showWalletConnectScanner() {\n    if (!this.useWalletConnect) throw new Error(\"Set `useWalletConnect` as true in init function options to use wallet connect scanner\");\n    return new Promise((resolve, reject) => {\n      if (this.isLoggedIn) {\n        const walletConnectStream = this.communicationMux.getStream(\"wallet_connect_stream\");\n\n        const walletConnectHandler = chunk => {\n          if (chunk.name === \"wallet_connect_stream_res\") {\n            if (chunk.data.success) {\n              resolve(chunk.data.success);\n            } else {\n              reject(new Error(chunk.data.error));\n            }\n\n            this._displayIframe();\n          }\n        };\n\n        handleStream(walletConnectStream, \"data\", walletConnectHandler);\n        walletConnectStream.write({\n          name: \"wallet_connect_stream_req\"\n        });\n\n        this._displayIframe(true);\n      } else reject(new Error(\"User has not logged in yet\"));\n    });\n  }\n\n  _handleWindow(preopenInstanceId) {\n    let {\n      url,\n      target,\n      features\n    } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    if (preopenInstanceId) {\n      const windowStream = this.communicationMux.getStream(\"window\");\n      const finalUrl = new URL(url || \"\".concat(this.torusUrl, \"/redirect?preopenInstanceId=\").concat(preopenInstanceId));\n\n      if (this.dappStorageKey) {\n        // If multiple instances, it returns the first one\n        if (finalUrl.hash) finalUrl.hash += \"&dappStorageKey=\".concat(this.dappStorageKey);else finalUrl.hash = \"#dappStorageKey=\".concat(this.dappStorageKey);\n      }\n\n      const handledWindow = new PopupHandler({\n        url: finalUrl,\n        target,\n        features\n      });\n      handledWindow.open();\n\n      if (!handledWindow.window) {\n        this._createPopupBlockAlert(preopenInstanceId, finalUrl.href);\n\n        return;\n      }\n\n      windowStream.write({\n        name: \"opened_window\",\n        data: {\n          preopenInstanceId\n        }\n      });\n\n      const closeHandler = _ref3 => {\n        let {\n          preopenInstanceId: receivedId,\n          close\n        } = _ref3;\n\n        if (receivedId === preopenInstanceId && close) {\n          handledWindow.close();\n          windowStream.removeListener(\"data\", closeHandler);\n        }\n      };\n\n      windowStream.on(\"data\", closeHandler);\n      handledWindow.once(\"close\", () => {\n        windowStream.write({\n          data: {\n            preopenInstanceId,\n            closed: true\n          }\n        });\n        windowStream.removeListener(\"data\", closeHandler);\n      });\n    }\n  }\n\n  _setEmbedWhiteLabel(element) {\n    // Set whitelabel\n    const {\n      theme\n    } = this.whiteLabel || {};\n\n    if (theme) {\n      const {\n        isDark = false,\n        colors = {}\n      } = theme;\n      if (isDark) element.classList.add(\"torus-dark\");\n      if (colors.torusBrand1) element.style.setProperty(\"--torus-brand-1\", colors.torusBrand1);\n      if (colors.torusGray2) element.style.setProperty(\"--torus-gray-2\", colors.torusGray2);\n    }\n  }\n\n  _getLogoUrl() {\n    var _this$whiteLabel, _this$whiteLabel$them;\n\n    let logoUrl = \"\".concat(this.torusUrl, \"/images/torus_icon-blue.svg\");\n\n    if ((_this$whiteLabel = this.whiteLabel) !== null && _this$whiteLabel !== void 0 && (_this$whiteLabel$them = _this$whiteLabel.theme) !== null && _this$whiteLabel$them !== void 0 && _this$whiteLabel$them.isDark) {\n      var _this$whiteLabel2;\n\n      logoUrl = ((_this$whiteLabel2 = this.whiteLabel) === null || _this$whiteLabel2 === void 0 ? void 0 : _this$whiteLabel2.logoLight) || logoUrl;\n    } else {\n      var _this$whiteLabel3;\n\n      logoUrl = ((_this$whiteLabel3 = this.whiteLabel) === null || _this$whiteLabel3 === void 0 ? void 0 : _this$whiteLabel3.logoDark) || logoUrl;\n    }\n\n    return logoUrl;\n  }\n\n  _sendWidgetVisibilityStatus(status) {\n    const torusWidgetVisibilityStream = this.communicationMux.getStream(\"torus-widget-visibility\");\n    torusWidgetVisibilityStream.write({\n      data: status\n    });\n  }\n\n  _displayIframe() {\n    let isFull = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    const style = {}; // set phase\n\n    if (!isFull) {\n      style.display = this.torusWidgetVisibility ? \"block\" : \"none\";\n      style.height = \"70px\";\n      style.width = \"70px\";\n\n      switch (this.buttonPosition) {\n        case BUTTON_POSITION.TOP_LEFT:\n          style.top = \"0px\";\n          style.left = \"0px\";\n          style.right = \"auto\";\n          style.bottom = \"auto\";\n          break;\n\n        case BUTTON_POSITION.TOP_RIGHT:\n          style.top = \"0px\";\n          style.right = \"0px\";\n          style.left = \"auto\";\n          style.bottom = \"auto\";\n          break;\n\n        case BUTTON_POSITION.BOTTOM_RIGHT:\n          style.bottom = \"0px\";\n          style.right = \"0px\";\n          style.top = \"auto\";\n          style.left = \"auto\";\n          break;\n\n        case BUTTON_POSITION.BOTTOM_LEFT:\n        default:\n          style.bottom = \"0px\";\n          style.left = \"0px\";\n          style.top = \"auto\";\n          style.right = \"auto\";\n          break;\n      }\n    } else {\n      style.display = \"block\";\n      style.width = \"100%\";\n      style.height = \"100%\";\n      style.top = \"0px\";\n      style.right = \"0px\";\n      style.left = \"0px\";\n      style.bottom = \"0px\";\n    }\n\n    Object.assign(this.torusIframe.style, style);\n    this.isIframeFullScreen = isFull;\n  }\n\n  _setupWeb3() {\n    log.info(\"setupWeb3 running\"); // setup background connection\n\n    const metamaskStream = new BasePostMessageStream({\n      name: \"embed_metamask\",\n      target: \"iframe_metamask\",\n      targetWindow: this.torusIframe.contentWindow,\n      targetOrigin: new URL(this.torusUrl).origin\n    }); // Due to compatibility reasons, we should not set up multiplexing on window.metamaskstream\n    // because the MetamaskInpageProvider also attempts to do so.\n    // We create another LocalMessageDuplexStream for communication between dapp <> iframe\n\n    const communicationStream = new BasePostMessageStream({\n      name: \"embed_comm\",\n      target: \"iframe_comm\",\n      targetWindow: this.torusIframe.contentWindow,\n      targetOrigin: new URL(this.torusUrl).origin\n    }); // Backward compatibility with Gotchi :)\n    // window.metamaskStream = this.communicationStream\n    // compose the inpage provider\n\n    const inpageProvider = new TorusInpageProvider(metamaskStream); // detect eth_requestAccounts and pipe to enable for now\n\n    const detectAccountRequestPrototypeModifier = m => {\n      const originalMethod = inpageProvider[m];\n\n      inpageProvider[m] = function providerFunc(method) {\n        if (method && method === \"eth_requestAccounts\") {\n          return inpageProvider.enable();\n        }\n\n        for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          args[_key - 1] = arguments[_key];\n        }\n\n        return originalMethod.apply(this, [method, ...args]);\n      };\n    };\n\n    detectAccountRequestPrototypeModifier(\"send\");\n    detectAccountRequestPrototypeModifier(\"sendAsync\");\n\n    inpageProvider.enable = () => {\n      return new Promise((resolve, reject) => {\n        // If user is already logged in, we assume they have given access to the website\n        inpageProvider.sendAsync({\n          jsonrpc: \"2.0\",\n          id: getPreopenInstanceId(),\n          method: \"eth_requestAccounts\",\n          params: []\n        }, (err, response) => {\n          const {\n            result: res\n          } = response || {};\n\n          if (err) {\n            setTimeout(() => {\n              reject(err);\n            }, 50);\n          } else if (Array.isArray(res) && res.length > 0) {\n            // If user is already rehydrated, resolve this\n            // else wait for something to be written to status stream\n            const handleLoginCb = () => {\n              if (this.requestedVerifier !== \"\" && this.currentVerifier !== this.requestedVerifier) {\n                const {\n                  requestedVerifier\n                } = this; // eslint-disable-next-line promise/no-promise-in-callback\n\n                this.logout() // eslint-disable-next-line promise/always-return\n                .then(_ => {\n                  this.requestedVerifier = requestedVerifier;\n\n                  this._showLoginPopup(true, resolve, reject);\n                }).catch(error => reject(error));\n              } else {\n                resolve(res);\n              }\n            };\n\n            if (this.isLoggedIn) {\n              handleLoginCb();\n            } else {\n              this.isLoginCallback = handleLoginCb;\n            }\n          } else {\n            // set up listener for login\n            this._showLoginPopup(true, resolve, reject);\n          }\n        });\n      });\n    };\n\n    inpageProvider.tryPreopenHandle = (payload, cb) => {\n      const _payload = payload;\n\n      if (!Array.isArray(_payload) && UNSAFE_METHODS.includes(_payload.method)) {\n        const preopenInstanceId = getPreopenInstanceId();\n\n        this._handleWindow(preopenInstanceId, {\n          target: \"_blank\",\n          features: FEATURES_CONFIRM_WINDOW\n        });\n\n        _payload.preopenInstanceId = preopenInstanceId;\n      }\n\n      inpageProvider._rpcEngine.handle(_payload, cb);\n    }; // Work around for web3@1.0 deleting the bound `sendAsync` but not the unbound\n    // `sendAsync` method on the prototype, causing `this` reference issues with drizzle\n\n\n    const proxiedInpageProvider = new Proxy(inpageProvider, {\n      // straight up lie that we deleted the property so that it doesnt\n      // throw an error in strict mode\n      deleteProperty: () => true\n    });\n    this.ethereum = proxiedInpageProvider;\n    const communicationMux = setupMultiplex(communicationStream);\n    this.communicationMux = communicationMux;\n    const windowStream = communicationMux.getStream(\"window\");\n    windowStream.on(\"data\", chunk => {\n      if (chunk.name === \"create_window\") {\n        // url is the url we need to open\n        // we can pass the final url upfront so that it removes the step of redirecting to /redirect and waiting for finalUrl\n        this._createPopupBlockAlert(chunk.data.preopenInstanceId, chunk.data.url);\n      }\n    }); // show torus widget if button clicked\n\n    const widgetStream = communicationMux.getStream(\"widget\");\n    widgetStream.on(\"data\", chunk => {\n      const {\n        data\n      } = chunk;\n\n      this._displayIframe(data);\n    }); // Show torus button if wallet has been hydrated/detected\n\n    const statusStream = communicationMux.getStream(\"status\");\n    statusStream.on(\"data\", status => {\n      // login\n      if (status.loggedIn) {\n        this.isLoggedIn = status.loggedIn;\n        this.currentVerifier = status.verifier;\n      } // logout\n      else this._displayIframe();\n\n      if (this.isLoginCallback) {\n        this.isLoginCallback();\n        delete this.isLoginCallback;\n      }\n    });\n    this.provider = proxiedInpageProvider;\n    if (this.provider.shouldSendMetadata) sendSiteMetadata(this.provider._rpcEngine);\n\n    inpageProvider._initializeState();\n\n    log.debug(\"Torus - injected provider\");\n  }\n\n  _showLoginPopup(calledFromEmbed, resolve, reject) {\n    const loginHandler = data => {\n      const {\n        err,\n        selectedAddress\n      } = data;\n\n      if (err) {\n        log.error(err);\n        if (reject) reject(err);\n      } // returns an array (cause accounts expects it)\n      else if (resolve) resolve([selectedAddress]);\n\n      if (this.isIframeFullScreen) this._displayIframe();\n    };\n\n    const oauthStream = this.communicationMux.getStream(\"oauth\");\n\n    if (!this.requestedVerifier) {\n      this._displayIframe(true);\n\n      handleStream(oauthStream, \"data\", loginHandler);\n      oauthStream.write({\n        name: \"oauth_modal\",\n        data: {\n          calledFromEmbed\n        }\n      });\n    } else {\n      handleStream(oauthStream, \"data\", loginHandler);\n      const preopenInstanceId = getPreopenInstanceId();\n\n      this._handleWindow(preopenInstanceId);\n\n      oauthStream.write({\n        name: \"oauth\",\n        data: {\n          calledFromEmbed,\n          verifier: this.requestedVerifier,\n          preopenInstanceId,\n          login_hint: this.loginHint\n        }\n      });\n    }\n  }\n\n  _createPopupBlockAlert(preopenInstanceId, url) {\n    const logoUrl = this._getLogoUrl();\n\n    const torusAlert = htmlToElement('<div id=\"torusAlert\" class=\"torus-alert--v2\">' + \"<div id=\\\"torusAlert__logo\\\"><img src=\\\"\".concat(logoUrl, \"\\\" /></div>\") + \"<div>\" + \"<h1 id=\\\"torusAlert__title\\\">\".concat(this.embedTranslations.actionRequired, \"</h1>\") + \"<p id=\\\"torusAlert__desc\\\">\".concat(this.embedTranslations.pendingAction, \"</p>\") + \"</div>\" + \"</div>\");\n    const successAlert = htmlToElement(\"<div><a id=\\\"torusAlert__btn\\\">\".concat(this.embedTranslations.continue, \"</a></div>\"));\n    const btnContainer = htmlToElement('<div id=\"torusAlert__btn-container\"></div>');\n    btnContainer.appendChild(successAlert);\n    torusAlert.appendChild(btnContainer);\n\n    const bindOnLoad = () => {\n      successAlert.addEventListener(\"click\", () => {\n        this._handleWindow(preopenInstanceId, {\n          url,\n          target: \"_blank\",\n          features: FEATURES_CONFIRM_WINDOW\n        });\n\n        torusAlert.remove();\n        if (this.torusAlertContainer.children.length === 0) this.torusAlertContainer.style.display = \"none\";\n      });\n    };\n\n    this._setEmbedWhiteLabel(torusAlert);\n\n    const attachOnLoad = () => {\n      this.torusAlertContainer.style.display = \"block\";\n      this.torusAlertContainer.appendChild(torusAlert);\n    };\n\n    runOnLoad(attachOnLoad);\n    runOnLoad(bindOnLoad);\n  }\n\n}\n\nexport { BUTTON_POSITION, LOGIN_PROVIDER, PAYMENT_PROVIDER, TORUS_BUILD_ENV, TorusInpageProvider, WALLET_OPENLOGIN_VERIFIER_MAP, Torus as default };","map":{"version":3,"mappings":"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","names":["LOGIN_PROVIDER","GOOGLE","FACEBOOK","TWITCH","REDDIT","DISCORD","WALLET_OPENLOGIN_VERIFIER_MAP","PAYMENT_PROVIDER","MOONPAY","WYRE","RAMPNETWORK","XANPOOL","MERCURYO","TRANSAK","TORUS_BUILD_ENV","PRODUCTION","DEVELOPMENT","BINANCE","TESTING","LRC","BETA","BUTTON_POSITION","BOTTOM_LEFT","TOP_LEFT","BOTTOM_RIGHT","TOP_RIGHT","paymentProviders","line1","line2","line3","supportPage","minOrderValue","maxOrderValue","validCurrencies","validCryptoCurrencies","includeFees","enforceMax","sell","translations","en","embed","continue","actionRequired","pendingAction","cookiesRequired","enableCookies","clickHere","de","ja","ko","zh","supportedVerifierList","api","prodTorusUrl","localStorageKey","window","location","hostname","runOnLoad","fn","Promise","resolve","reject","document","body","then","catch","addEventListener","htmlToElement","html","template","createElement","trimmedHtml","trim","innerHTML","content","firstChild","handleEvent","handle","eventName","handler","handlerArgs","handlerWrapper","removeEventListener","handleStream","chunk","removeListener","on","documentReady","readyState","loglevel","getLogger","errors","disconnected","permanentlyDisconnected","sendSiteMetadata","unsupportedSync","method","invalidDuplexStream","invalidOptions","maxEventListeners","shouldSendMetadata","invalidRequestArgs","invalidRequestMethod","invalidRequestParams","invalidLoggerObject","invalidLoggerMethod","info","connected","chainId","warnings","enableDeprecation","sendDeprecation","events","close","data","networkChanged","notification","publicConfigStore","config","validatePaymentProvider","provider","params","isValid","Object","keys","length","selectedProvider","selectedParams","fiatValue","requestedOrderAmount","parseFloat","toString","selectedCurrency","includes","selectedCryptoCurrency","createErrorMiddleware","req","res","next","error","ethErrors","rpc","invalidRequest","message","done","log","logStreamDisconnectWarning","remoteLabel","emitter","warningMsg","stack","warn","listenerCount","emit","getPreopenInstanceId","Math","random","slice","getTorusUrl","buildEnv","integrity","torusUrl","logLevel","version","versionUsed","response","get","useAPIKey","getUserLanguage","userLanguage","navigator","language","userLanguages","split","prototype","hasOwnProperty","call","EMITTED_NOTIFICATIONS","NOOP","FEATURES_PROVIDER_CHANGE_WINDOW","FEATURES_DEFAULT_WALLET_WINDOW","FEATURES_CONFIRM_WINDOW","storageAvailable","type","storage","x","setItem","removeItem","e","code","name","getPopupFeatures","dualScreenLeft","screenLeft","undefined","screenX","dualScreenTop","screenTop","screenY","w","h","width","innerWidth","documentElement","clientWidth","screen","height","innerHeight","clientHeight","systemZoom","left","abs","top","features","SafeEventEmitter","defaultMaxListeners","getRpcPromiseCallback","unwrapResult","Array","isArray","result","TorusInpageProvider","constructor","connectionStream","jsonRpcStreamName","enable","experimentalMethods","send","isDuplexStream","Error","messages","isTorus","setMaxListeners","_state","_defaultState","selectedAddress","networkVersion","_handleAccountsChanged","bind","_handleChainChanged","_handleUnlockStateChanged","_handleConnect","_handleDisconnect","_handleStreamDisconnect","_sendSync","_rpcRequest","_warnOfDeprecation","_initializeState","request","sendAsync","mux","ObjectMultiplex","pump","_publicConfigStore","ObservableStore","storageKey","createStream","storeAsStream","ignoreStream","isConnected","jsonRpcConnection","createStreamMiddleware","stream","rpcEngine","JRPCEngine","push","createIdRemapMiddleware","middleware","_rpcEngine","payload","_sentWarnings","args","callback","addListener","listener","once","prependListener","prependOnceListener","accounts","isUnlocked","initialized","isInternal","cb","_payload","jsonrpc","err","tryPreopenHandle","methodOrPayload","callbackOrArgs","id","debug","isRecoverable","errorMessage","isPermanentlyDisconnected","EthereumRpcError","streamName","isEthAccounts","finalAccounts","account","dequal","hasEmittedConnection","defaults","options","algorithms","delimiter","full","hashes","internalHashes","forEach","algorithm","createHash","update","digest","sri","output","map","join","main","finalOptions","PopupHandler","EventEmitter","url","target","windowTimer","iClosedWindow","_setupTimer","Number","setInterval","closed","clearInterval","open","href","_this$window","focus","redirect","locationReplaceOnRedirect","replace","imgExists","img","onload","onerror","src","getSiteName","siteName","querySelector","metaTitle","title","getSiteIcon","icon","from","querySelectorAll","find","_icon","Boolean","getSiteMetadata","engine","domainMetadata","originalError","defaultVerifiers","iframeIntegrity","expectedCacheControlHeader","UNSAFE_METHODS","isLocalStorageAvailable","preLoadIframe","torusIframeHtml","check","hash","crossOrigin","rel","relList","supports","head","appendChild","Torus","buttonPosition","modalZIndex","apiKey","configuration","isLoggedIn","isInitialized","torusWidgetVisibility","requestedVerifier","currentVerifier","nodeDetailManager","NodeDetailManager","torusJs","TorusJs","metadataHost","allowHost","setAPIKey","alertZIndex","isIframeFullScreen","dappStorageKey","init","enableLogging","enabledVerifiers","network","host","networkName","blockExplorer","ticker","tickerName","loginConfig","showTorusButton","whiteLabel","skipTKey","useLocalStorage","useWalletConnect","setDefaultLevel","enableAll","disableAll","storedKey","localStorage","getItem","generatedKey","torusIframeUrl","URL","pathname","endsWith","torusIframe","torusAlertContainer","style","display","setProperty","link","setAttribute","styleLink","defaultLanguage","customTranslations","mergedTranslations","deepmerge","languageTranslations","embedTranslations","handleSetup","_setupWeb3","initStream","communicationMux","getStream","success","_displayIframe","write","fetchUrl","resp","fetch","cache","headers","text","calculatedIntegrity","generateIntegrity","clearInit","login","verifier","login_hint","loginHint","ethereum","logout","logOutStream","statusStream","statusStreamHandler","status","loggedIn","cleanUp","isElement","element","Element","HTMLDocument","contains","remove","torusAlert","hideTorusButton","_sendWidgetVisibilityStatus","setProvider","rest","providerChangeStream","preopenInstanceId","_handleWindow","override","showWallet","path","showWalletStream","finalPath","showWalletHandler","instanceId","finalUrl","searchParams","append","walletWindow","getPublicAddress","verifierId","isExtended","nodeDetails","getNodeDetails","endpoints","torusNodeEndpoints","torusNodePubs","torusNodePub","walletVerifier","openloginVerifier","existingV1User","getUserTypeAndAddress","typeOfUser","address","v2User","newV2User","getUserInfo","userInfoAccessStream","userInfoAccessHandler","approved","rejected","newRequest","userInfoStream","userInfoHandler","handlerChunk","initiateTopup","JSON","stringify","topupStream","topupHandler","loginWithPrivateKey","loginParams","privateKey","userInfo","Buffer","loginPrivKeyStream","loginHandler","showWalletConnectScanner","walletConnectStream","walletConnectHandler","windowStream","handledWindow","_createPopupBlockAlert","closeHandler","_ref3","receivedId","_setEmbedWhiteLabel","theme","isDark","colors","classList","add","torusBrand1","torusGray2","_getLogoUrl","logoUrl","_this$whiteLabel","_this$whiteLabel$them","logoLight","logoDark","torusWidgetVisibilityStream","isFull","right","bottom","assign","metamaskStream","BasePostMessageStream","targetWindow","contentWindow","targetOrigin","origin","communicationStream","inpageProvider","detectAccountRequestPrototypeModifier","m","originalMethod","providerFunc","apply","setTimeout","handleLoginCb","_","_showLoginPopup","isLoginCallback","proxiedInpageProvider","Proxy","deleteProperty","setupMultiplex","widgetStream","calledFromEmbed","oauthStream","successAlert","btnContainer","bindOnLoad","children","attachOnLoad"],"sources":["../src/interfaces.ts","../src/config.ts","../src/embedUtils.ts","../src/loglevel.ts","../src/messages.ts","../src/utils.ts","../src/inpage-provider.ts","../src/integrity.ts","../src/PopupHandler.ts","../src/siteMetadata.ts","../src/embed.ts"],"sourcesContent":[null,null,null,null,null,null,null,null,null,null,null]},"metadata":{},"sourceType":"module"}